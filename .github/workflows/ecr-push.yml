name: Build and Deploy to ECS

on:
  workflow_call:
    inputs:
      ecr_repo_name:
        type: string
        required: false
        default: ""
      ecs_cluster_arn:
        type: string
        required: false
        default: ""
      ecs_service_arn:
        type: string
        required: false
        default: ""
  workflow_dispatch:
    inputs:
      ecr_repo_name:
        type: string
        required: false
        default: ""
      ecs_cluster_arn:
        type: string
        required: false
        default: ""
      ecs_service_arn:
        type: string
        required: false
        default: ""

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials with OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::368339042148:role/github_deploy
          aws-region: ap-southeast-1

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get ECR repository URI
        if: inputs.ecr_repo_name == ''
        id: get-ecr
        run: |
          ECR_REPO=$(aws ecr describe-repositories --query 'repositories[0].repositoryUri' --output text)
          echo "ecr_repo=$ECR_REPO" >> $GITHUB_OUTPUT
          echo "ECR Repository: $ECR_REPO"

      - name: Get ECS cluster and service ARNs
        if: inputs.ecs_cluster_arn == '' || inputs.ecs_service_arn == ''
        id: get-ecs
        run: |
          CLUSTER_ARN=$(aws ecs list-clusters --query 'clusterArns[0]' --output text)
          SERVICE_ARN=$(aws ecs list-services --cluster $CLUSTER_ARN --query 'serviceArns[0]' --output text)
          
          echo "cluster_arn=$CLUSTER_ARN" >> $GITHUB_OUTPUT
          echo "service_arn=$SERVICE_ARN" >> $GITHUB_OUTPUT
          echo "ECS Cluster ARN: $CLUSTER_ARN"
          echo "ECS Service ARN: $SERVICE_ARN"

      - name: Set resources from inputs or discovery
        id: set-resources
        run: |
          if [ -n "${{ inputs.ecr_repo_name }}" ]; then
            ECR_REGISTRY="${{ steps.login-ecr.outputs.registry }}"
            ECR_REPO="$ECR_REGISTRY/${{ inputs.ecr_repo_name }}"
            echo "Using ECR repo from input: $ECR_REPO"
          else
            ECR_REPO="${{ steps.get-ecr.outputs.ecr_repo }}"
            echo "Using ECR repo from discovery: $ECR_REPO"
          fi
          
          if [ -n "${{ inputs.ecs_cluster_arn }}" ]; then
            CLUSTER="${{ inputs.ecs_cluster_arn }}"
            SERVICE="${{ inputs.ecs_service_arn }}"
            echo "Using cluster ARN from input: $CLUSTER"
            echo "Using service ARN from input: $SERVICE"
          else
            CLUSTER="${{ steps.get-ecs.outputs.cluster_arn }}"
            SERVICE="${{ steps.get-ecs.outputs.service_arn }}"
            echo "Using cluster ARN from discovery: $CLUSTER"
            echo "Using service ARN from discovery: $SERVICE"
          fi
          
          echo "ecr_repo=$ECR_REPO" >> $GITHUB_OUTPUT
          echo "cluster=$CLUSTER" >> $GITHUB_OUTPUT
          echo "service=$SERVICE" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.set-resources.outputs.ecr_repo }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Force new ECS deployment
        env:
          CLUSTER: ${{ steps.set-resources.outputs.cluster }}
          SERVICE: ${{ steps.set-resources.outputs.service }}
        run: |
          aws ecs update-service \
            --cluster $CLUSTER \
            --service $SERVICE \
            --force-new-deployment
          
          echo "Deployment initiated for service $SERVICE"
