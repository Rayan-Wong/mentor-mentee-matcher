name: Terraform Plan (Orchestrator)

on:
  workflow_dispatch:
    inputs:
      do_destroy:
        type: boolean
        default: false
        description: "Generate destroy plan?"
      release_stale_lock:
        type: boolean
        default: false
        description: "Allow forced unlock if lock is stale?"

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install graph-easy
        run: sudo apt-get update && sudo apt-get install -y libgraph-easy-perl

      - name: AWS OIDC Auth
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::368339042148:role/asp_proj-terraform-deploy
          aws-region: ap-southeast-1

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.13.5"

      # ---- Init with real backend ----
      - name: Terraform Init
        working-directory: terraform
        run: terraform init -input=false

      # ---- Cleanup ECS and ECR before destroy plan ----
      - name: Get ECS Cluster and Service Names
        if: github.event.inputs.do_destroy == 'true'
        id: get-ecs-info
        run: |
          CLUSTER_NAME=$(aws ecs list-clusters --region ap-southeast-1 --query 'clusterArns[0]' --output text | awk -F'/' '{print $NF}')
          SERVICE_NAME=$(aws ecs list-services --cluster $CLUSTER_NAME --region ap-southeast-1 --query 'serviceArns[0]' --output text | awk -F'/' '{print $NF}')
          echo "cluster_name=$CLUSTER_NAME" >> $GITHUB_OUTPUT
          echo "service_name=$SERVICE_NAME" >> $GITHUB_OUTPUT
          echo "Found ECS Cluster: $CLUSTER_NAME"
          echo "Found ECS Service: $SERVICE_NAME"
        continue-on-error: true

      - name: Scale ECS Service to Zero
        if: github.event.inputs.do_destroy == 'true'
        run: |
          aws ecs update-service \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --service ${{ steps.get-ecs-info.outputs.service_name }} \
            --desired-count 0 \
            --region ap-southeast-1
          echo "Scaled ECS service to 0 tasks"
        continue-on-error: true

      - name: Wait for Tasks to Stop
        if: github.event.inputs.do_destroy == 'true'
        run: |
          echo "Waiting for all tasks to stop..."
          aws ecs wait services-stable \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --services ${{ steps.get-ecs-info.outputs.service_name }} \
            --region ap-southeast-1
          echo "All tasks have stopped"
        continue-on-error: true

      - name: Delete Images from ECR
        if: github.event.inputs.do_destroy == 'true'
        run: |
          set -e
          REPOSITORIES=$(aws ecr describe-repositories --region ap-southeast-1 --query 'repositories[*].repositoryName' --output text)
          FAILED=0
          for REPO in $REPOSITORIES; do
            echo "Processing repository: $REPO"
            IMAGE_IDS=$(aws ecr list-images --repository-name $REPO --region ap-southeast-1 --query 'imageIds[*]' --output json)
            if [ "$IMAGE_IDS" != "[]" ]; then
              if aws ecr batch-delete-image \
                --repository-name $REPO \
                --image-ids "$IMAGE_IDS" \
                --region ap-southeast-1; then
                echo "Successfully deleted images from $REPO"
              else
                echo "Failed to delete images from $REPO"
                FAILED=1
              fi
            else
              echo "No images found in $REPO"
            fi
          done
          if [ $FAILED -eq 1 ]; then
            echo "One or more repositories failed to delete images"
            exit 1
          fi

      # ---- Generate and display Terraform graph ----
      - name: Generate Terraform Graph
        working-directory: terraform
        run: |
          terraform graph > terraform-graph.dot
          graph-easy terraform-graph.dot --as=ascii > terraform-graph.txt
          echo "### Terraform Dependency Graph (ASCII)" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat terraform-graph.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      # ---- Initial plan attempt ----
      - name: Terraform Plan Attempt
        id: plan
        working-directory: terraform
        continue-on-error: true
        run: |
          if [ "${{ github.event.inputs.do_destroy }}" = "true" ]; then
            terraform plan -destroy -out=tfdestroy | tee plan.log
          else
            terraform plan -out=tfplan | tee plan.log
          fi

      # ---- Detect lock conflict ----
      - name: Lock Conflict Check
        id: lockcheck
        run: |
          if grep -q "Error acquiring the state lock" terraform/plan.log; then
            echo "lock_conflict=true" >> $GITHUB_OUTPUT
          else
            echo "lock_conflict=false" >> $GITHUB_OUTPUT
          fi

      # ---- Extract lock ID (only if override selected) ----
      - name: Extract Lock ID
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        id: lock_id
        working-directory: terraform
        run: |
          LOCK_ID=$(grep -oE 'ID:[[:space:]]*[0-9a-fA-F-]{36}' plan.log | head -1 | grep -oE '[0-9a-fA-F-]{36}')
          echo "id=$LOCK_ID" >> $GITHUB_OUTPUT

      # ---- Force unlock stale lock ----
      - name: Force Unlock
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        working-directory: terraform
        run: terraform force-unlock -force ${{ steps.lock_id.outputs.id }}

      # ---- Retry plan ----
      - name: Terraform Plan Retry
        if: steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true'
        working-directory: terraform
        run: |
          if [ "${{ github.event.inputs.do_destroy }}" = "true" ]; then
            terraform plan -destroy -out=tfdestroy
          else
            terraform plan -out=tfplan
          fi

      # ---- Fail if plan failed and lock not released ----
      - name: Check Plan Success
        if: steps.plan.outcome == 'failure' && (steps.lockcheck.outputs.lock_conflict != 'true' || github.event.inputs.release_stale_lock != 'true')
        run: |
          echo "Plan failed and lock was not released"
          exit 1

      # ---- Restore ECS Service on Failure ----
      - name: Restore ECS Service Desired Count
        if: failure() && github.event.inputs.do_destroy == 'true' && steps.get-ecs-info.outputs.cluster_name != '' && steps.get-ecs-info.outputs.service_name != ''
        run: |
          echo "Workflow failed - restoring ECS service to desired count 1"
          aws ecs update-service \
            --cluster ${{ steps.get-ecs-info.outputs.cluster_name }} \
            --service ${{ steps.get-ecs-info.outputs.service_name }} \
            --desired-count 1 \
            --region ap-southeast-1
          echo "ECS service restored to 1 task"
        continue-on-error: true

      # ---- Upload plan artifact ----
      - name: Upload Plan
        if: steps.plan.outcome == 'success' || (steps.lockcheck.outputs.lock_conflict == 'true' && github.event.inputs.release_stale_lock == 'true')
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.do_destroy == 'true' && 'terraform-destroy-plan' || 'terraform-plan' }}
          path: terraform/${{ github.event.inputs.do_destroy == 'true' && 'tfdestroy' || 'tfplan' }}
          retention-days: 7

  # ---- Trigger apply or destroy ----
  trigger-apply:
    needs: plan
    if: github.event.inputs.do_destroy != 'true'
    permissions:
      id-token: write
      contents: write
    uses: ./.github/workflows/terraform-apply.yml
    secrets: inherit
    with:
      plan_artifact: terraform-plan

  trigger-destroy:
    needs: plan
    if: github.event.inputs.do_destroy == 'true'
    permissions:
      id-token: write
      contents: write
    uses: ./.github/workflows/terraform-delete.yml
    secrets: inherit
    with:
      plan_artifact: terraform-destroy-plan
